<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Travel Register Teams App - Mobile</title>
    <!-- Microsoft Teams SDK -->
    <script src="https://res.cdn.office.net/teams-js/2.0.0/js/MicrosoftTeams.min.js"></script>
    <!-- Google Maps JavaScript API -->
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAkIyRLkKqppA_A7FdlDZUuwTU8x0yqm9Y&libraries=places&callback=initMap"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #ffffff; min-height: 100vh; -webkit-overflow-scrolling: touch; transition: background-color 0.3s ease, color 0.3s ease; }
        .desktop-container { background: #ffffff; min-height: 100vh; display: flex; flex-direction: column; transition: background-color 0.3s ease; }
        .tab-navigation { background: #ffffff; border-bottom: 1px solid #e1dfdd; display: flex; flex-shrink: 0; overflow-x: auto; -webkit-overflow-scrolling: touch; scrollbar-width: none; -ms-overflow-style: none; transition: background-color 0.3s ease, border-color 0.3s ease; }
        .tab-navigation::-webkit-scrollbar { display: none; }
        .tab-button { background: none; border: none; padding: 12px 16px; cursor: pointer; font-size: 13px; font-weight: 500; color: #424242; border-bottom: 3px solid transparent; transition: all 0.3s ease; white-space: nowrap; display: flex; align-items: center; gap: 6px; min-width: fit-content; flex-shrink: 0; }
        .tab-button.active { color: #6264a7; border-bottom-color: #6264a7; background: #ffffff; }
        .tab-button:hover { background: #edebe9; }
        .tab-icon { font-size: 14px; }
        .main-content { flex: 1; display: flex; padding: 16px; min-height: 0; }
        .form-container { flex: 1; background: #ffffff; border-radius: 0; padding: 24px; display: none; overflow-y: auto; width: 100%; transition: background-color 0.3s ease, color 0.3s ease; border: none; }
        .form-container.active { display: block; }
        .form-header { text-align: center; margin-bottom: 28px; }
        .form-header h2 { color: #323130; font-size: 24px; margin-bottom: 8px; transition: color 0.3s ease; }
        .form-header p { color: #605e5c; font-size: 14px; line-height: 1.4; transition: color 0.3s ease; }
        .form-group { margin-bottom: 24px; }
        .form-group.hidden { display: none; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #323130; font-size: 14px; transition: color 0.3s ease; }
        .required-asterisk { color: #d13438; margin-left: 2px; }
        .optional-label { color: #605e5c; font-weight: normal; margin-left: 4px; font-size: 12px; }
        input, select, textarea { width: 100%; padding: 16px; border: 1px solid #8a8886; border-radius: 4px; font-size: 16px; transition: border-color 0.3s, box-shadow 0.3s, background-color 0.3s ease, color 0.3s ease; -webkit-appearance: none; appearance: none; background: #ffffff; color: #323130; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #6264a7; box-shadow: 0 0 0 1px #6264a7; }
        select { background-image: url('data:image/svg+xml;charset=US-ASCII,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 4 5"><path fill="%23605e5c" d="M2 0L0 2h4zm0 5L0 3h4z"/></svg>'); background-repeat: no-repeat; background-position: right 16px center; background-size: 16px; padding-right: 48px; }
        .datetime-group { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .datetime-field { display: flex; flex-direction: column; }
        .datetime-field label { margin-bottom: 8px; font-size: 12px; color: #605e5c; font-weight: 500; transition: color 0.3s ease; }
        .address-input-container { position: relative; }
        .address-input { padding-right: 40px; }
        .location-icon { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #6264a7; cursor: pointer; font-size: 18px; }
        .map-container { height: 200px; border: 1px solid #8a8886; border-radius: 4px; margin-top: 12px; overflow: hidden; display: none; }
        .map-container.show { display: block; }
        #map { width: 100%; height: 100%; }
        .travel-info { background: #f3f2f1; border: 1px solid #d2d0ce; border-radius: 4px; padding: 16px; margin-top: 12px; display: none; }
        .travel-info.show { display: block; }
        .travel-info h4 { color: #323130; font-size: 14px; margin-bottom: 8px; display: flex; align-items: center; gap: 6px; }
        .travel-time { font-size: 18px; font-weight: 600; color: #6264a7; margin-bottom: 4px; }
        .travel-distance { font-size: 14px; color: #605e5c; }
        .loading-spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid #d2d0ce; border-radius: 50%; border-top-color: #6264a7; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .flight-group { display: none; opacity: 0; transition: opacity 0.3s; }
        .flight-group.show { display: block; opacity: 1; }
        /* NEW: Flight address group - plain text, no maps */
        .flight-address-group { display: none; opacity: 0; transition: opacity 0.3s; }
        .flight-address-group.show { display: block; opacity: 1; }
        .car-travel-section { display: none; opacity: 0; transition: opacity 0.3s; }
        .car-travel-section.show { display: block; opacity: 1; }
        .action-buttons { display: flex; flex-direction: column; gap: 12px; margin-top: 24px; }
        .action-buttons.horizontal { flex-direction: row; gap: 12px; }
        .submit-btn { width: 100%; background: #6264a7; color: white; padding: 18px; border: none; border-radius: 4px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; min-height: 56px; }
        .submit-btn:hover { background: #464775; }
        .submit-btn:active { transform: scale(0.98); }
        .cancel-btn { width: 100%; background: #d13438; color: white; padding: 18px; border: none; border-radius: 4px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; min-height: 56px; }
        .cancel-btn:hover { background: #a4262c; }
        .cancel-btn:active { transform: scale(0.98); }
        .arrived-btn { width: 100%; background: #107c10; color: white; padding: 18px; border: none; border-radius: 4px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; min-height: 56px; }
        .arrived-btn:hover { background: #0e6e0e; }
        .arrived-btn:active { transform: scale(0.98); }
        .secondary-btn { width: 100%; background: #f3f2f1; color: #323130; border: 1px solid #8a8886; padding: 18px; border-radius: 4px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; min-height: 56px; }
        .secondary-btn:hover { background: #edebe9; }
        .secondary-btn:active { transform: scale(0.98); }
        .info-box { background: #deecf9; color: #003a6b; padding: 16px; border-radius: 4px; margin-bottom: 24px; border-left: 4px solid #0078d4; font-size: 13px; line-height: 1.4; transition: background-color 0.3s ease, color 0.3s ease; }
        .warning-box { background: #fff4ce; color: #323130; padding: 16px; border-radius: 4px; margin-bottom: 24px; border-left: 4px solid #ffb900; font-size: 13px; line-height: 1.4; transition: background-color 0.3s ease, color 0.3s ease; }
        .success-message { background: #dff6dd; color: #107c10; padding: 16px; border-radius: 4px; margin-bottom: 24px; border-left: 4px solid #107c10; display: none; font-size: 13px; line-height: 1.4; transition: background-color 0.3s ease, color 0.3s ease; }
        .error-message { background: #fde7e9; color: #a80000; padding: 16px; border-radius: 4px; margin-bottom: 24px; border-left: 4px solid #d13438; display: none; font-size: 13px; line-height: 1.4; transition: background-color 0.3s ease, color 0.3s ease; }
        textarea { resize: vertical; min-height: 100px; font-family: inherit; }
        .manage-section { border: 1px solid #e1dfdd; border-radius: 8px; padding: 20px; margin-bottom: 24px; background: #fafafa; transition: background-color 0.3s ease, border-color 0.3s ease; }
        .manage-section h3 { color: #323130; font-size: 18px; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; transition: color 0.3s ease; }
        .manage-section p { color: #605e5c; font-size: 14px; margin-bottom: 16px; line-height: 1.4; transition: color 0.3s ease; }
        .demo-badge { display: none; }
        .theme-badge { display: none; }
        @media (max-width: 480px) {
            .main-content { padding: 12px; }
            .form-container { padding: 20px; }
            .form-header h2 { font-size: 22px; }
            .datetime-group { grid-template-columns: 1fr; gap: 20px; }
            .tab-button { padding: 10px 12px; font-size: 12px; }
            .tab-icon { font-size: 13px; }
            .map-container { height: 180px; }
            .action-buttons.horizontal { flex-direction: column; }
        }
        @media (max-width: 360px) {
            .form-container { padding: 16px; }
            .form-header h2 { font-size: 20px; }
            .app-title { font-size: 16px; }
            .map-container { height: 160px; }
        }
        @media (max-height: 500px) and (orientation: landscape) {
            .form-header { margin-bottom: 16px; }
            .form-header h2 { font-size: 20px; margin-bottom: 4px; }
            .form-group { margin-bottom: 16px; }
            .map-container { height: 120px; }
        }
        /* Dark Theme */
        .teams-dark-theme { background: #292828; }
        .teams-dark-theme .desktop-container { background: #292828; }
        .teams-dark-theme .form-container { background: #292828; color: #ffffff; border: none; }
        .teams-dark-theme .form-header h2 { color: #ffffff; }
        .teams-dark-theme .form-header p { color: #d2d0ce; }
        .teams-dark-theme label { color: #ffffff; }
        .teams-dark-theme .datetime-field label { color: #d2d0ce; }
        .teams-dark-theme .optional-label { color: #a19f9d; }
        .teams-dark-theme input, .teams-dark-theme select, .teams-dark-theme textarea { background: #1a1a1a; border-color: #484644; color: #ffffff; }
        .teams-dark-theme input:focus, .teams-dark-theme select:focus, .teams-dark-theme textarea:focus { border-color: #6264a7; box-shadow: 0 0 0 1px #6264a7; }
        .teams-dark-theme .tab-navigation { background: #000000; border-bottom-color: #484644; }
        .teams-dark-theme .tab-button { color: #d2d0ce; }
        .teams-dark-theme .tab-button.active { background: #000000; color: #6264a7; }
        .teams-dark-theme .tab-button:hover { background: #1a1a1a; }
        .teams-dark-theme .travel-info { background: #1a1a1a; border-color: #484644; }
        .teams-dark-theme .travel-info h4 { color: #ffffff; }
        .teams-dark-theme .manage-section { background: #1a1a1a; border-color: #484644; }
        .teams-dark-theme .manage-section h3 { color: #ffffff; }
        .teams-dark-theme .manage-section p { color: #d2d0ce; }
        .teams-dark-theme .secondary-btn { background: #1a1a1a; color: #ffffff; border-color: #484644; }
        .teams-dark-theme .secondary-btn:hover { background: #2a2a2a; }
        .teams-dark-theme .info-box { background: #004578; color: #b3d6fc; border-left-color: #0078d4; }
        .teams-dark-theme .warning-box { background: #4f4000; color: #fff100; border-left-color: #ffb900; }
        .teams-dark-theme .success-message { background: #0e4b0e; color: #92c353; border-left-color: #92c353; }
        .teams-dark-theme .error-message { background: #442726; color: #f7b2b2; border-left-color: #d13438; }
        .teams-dark-theme select { background: #1a1a1a url('data:image/svg+xml;charset=US-ASCII,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 4 5"><path fill="%23d2d0ce" d="M2 0L0 2h4zm0 5L0 3h4z"/></svg>') no-repeat right 16px center; background-size: 16px; }
        /* High Contrast Theme */
        .teams-contrast-theme { background: #000000; }
        .teams-contrast-theme .desktop-container { background: #000000; }
        .teams-contrast-theme .form-container { background: #000000; color: #ffffff; border: 2px solid #ffffff; }
        .teams-contrast-theme .form-header h2 { color: #ffffff; }
        .teams-contrast-theme .form-header p { color: #ffffff; }
        .teams-contrast-theme label { color: #ffffff; }
        .teams-contrast-theme .datetime-field label { color: #ffffff; }
        .teams-contrast-theme .optional-label { color: #ffffff; }
        .teams-contrast-theme input, .teams-contrast-theme select, .teams-contrast-theme textarea { background: #000000; border: 2px solid #ffffff; color: #ffffff; }
        .teams-contrast-theme input:focus, .teams-contrast-theme select:focus, .teams-contrast-theme textarea:focus { border-color: #ffff00; box-shadow: 0 0 0 3px #ffff00; }
        .teams-contrast-theme .tab-navigation { background: #000000; border-bottom: 2px solid #ffffff; }
        .teams-contrast-theme .tab-button { color: #ffffff; border: 1px solid #ffffff; margin: 2px; }
        .teams-contrast-theme .tab-button.active { background: #ffffff; color: #000000; }
        .teams-contrast-theme .tab-button:hover { background: #ffffff; color: #000000; }
        .teams-contrast-theme .submit-btn { background: #ffffff; color: #000000; border: 2px solid #ffffff; }
        .teams-contrast-theme .submit-btn:hover { background: #ffff00; color: #000000; }
        .teams-contrast-theme .cancel-btn, .teams-contrast-theme .arrived-btn, .teams-contrast-theme .secondary-btn { background: #ffffff; color: #000000; border: 2px solid #ffffff; }
        .teams-contrast-theme .cancel-btn:hover, .teams-contrast-theme .arrived-btn:hover, .teams-contrast-theme .secondary-btn:hover { background: #ffff00; color: #000000; }
        .teams-contrast-theme .travel-info, .teams-contrast-theme .manage-section { background: #000000; border: 2px solid #ffffff; }
        .teams-contrast-theme .travel-info h4, .teams-contrast-theme .manage-section h3 { color: #ffffff; }
        .teams-contrast-theme .manage-section p { color: #ffffff; }
        .teams-contrast-theme .info-box, .teams-contrast-theme .warning-box, .teams-contrast-theme .success-message, .teams-contrast-theme .error-message { background: #000000; color: #ffffff; border: 2px solid #ffffff; border-left: 4px solid #ffff00; }
        .teams-contrast-theme select { background: #000000 url('data:image/svg+xml;charset=US-ASCII,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 4 5"><path fill="%23ffffff" d="M2 0L0 2h4zm0 5L0 3h4z"/></svg>') no-repeat right 16px center; background-size: 16px; }
        .back-button-container { position: fixed; top: 80px; left: 20px; z-index: 1000; }
        .back-button { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); color: #2c3e50; border: none; padding: 12px 18px; border-radius: 25px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 8px 25px rgba(0,0,0,0.1); text-decoration: none; display: flex; align-items: center; gap: 8px; }
        .back-button:hover { transform: translateY(-2px); box-shadow: 0 12px 30px rgba(0,0,0,0.15); background: rgba(255, 255, 255, 1); }
        .back-button:active { transform: translateY(0); }
        @media (max-width: 768px) {
            .back-button-container { position: relative; top: 0; left: 0; margin: 15px 0; text-align: left; padding: 0 20px; }
            .back-button { position: relative; display: inline-flex; }
        }
    </style>
</head>
<body>
    <div class="back-button-container">
        <a href="index.html" class="back-button"><span>‚Üê</span> Back to Home</a>
    </div>
    <div class="demo-badge">üì± Mobile Ready</div>
    <div class="theme-badge" id="themeBadge">üåü Default</div>
    
    <div class="desktop-container">
        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <button class="tab-button active" onclick="showTab('register', event)">
                <span class="tab-icon">‚úàÔ∏è</span>
                Register Travel
            </button>
            <button class="tab-button" onclick="showTab('manage', event)">
                <span class="tab-icon">üîß</span>
                Manage Trip
            </button>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Travel Register Form -->
            <div id="register" class="form-container active">
                <div class="form-header">
                    <h2>‚úàÔ∏è Travel Register</h2>
                    <p>Submit your travel details for tracking and coordination</p>
                </div>

                <div class="success-message" id="successMessage1">
                    Travel details submitted successfully! ‚úÖ
                </div>
                <div class="error-message" id="errorMessage1">
                    Error submitting travel details. Please try again.
                </div>

                <form id="travelForm">
                    <div class="form-group hidden">
                        <input type="email" id="userEmail1" required>
                    </div>

                    <div class="form-group">
                        <label for="transport">Mode of Transport<span class="required-asterisk">*</span></label>
                        <select id="transport" required>
                            <option value="">Select transport method</option>
                            <option value="Flight">Flight</option>
                            <option value="Car">Car</option>
                        </select>
                    </div>

                    <!-- Flight Number (Flight only) -->
                    <div class="form-group flight-group" id="flightGroup">
                        <label for="flightNumber">Flight Number</label>
                        <input type="text" id="flightNumber" placeholder="e.g., AA123" style="text-transform: uppercase;">
                    </div>

                    <!-- End of Trip Address for FLIGHT (autocomplete, no map) -->
                    <div class="flight-address-group" id="flightAddressGroup">
                        <div class="form-group">
                            <label for="flightDestination">End of Trip Address</label>
                            <input type="text" id="flightDestination" placeholder="Search for an address...">
                        </div>
                    </div>

                    <!-- Destination Address + Map for CAR -->
                    <div class="car-travel-section" id="carTravelSection">
                        <div class="form-group">
                            <label for="destination">End of Trip Address</label>
                            <div class="address-input-container">
                                <input type="text" id="destination" class="address-input" placeholder="Enter destination address for travel time calculation">
                                <span class="location-icon" onclick="getCurrentLocation()" title="Use current location">üìç</span>
                            </div>
                            <div class="map-container" id="mapContainer">
                                <div id="map"></div>
                            </div>
                            <div class="travel-info" id="travelInfo">
                                <h4>üöó Travel Information</h4>
                                <div class="travel-time" id="travelTime"><span class="loading-spinner"></span> Calculating...</div>
                                <div class="travel-distance" id="travelDistance"></div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Estimated Time of Arrival (ETA)<span class="required-asterisk">*</span></label>
                        <div class="datetime-group">
                            <div class="datetime-field">
                                <label for="etaDate1">Date</label>
                                <input type="date" id="etaDate1" required>
                            </div>
                            <div class="datetime-field">
                                <label for="etaTime1">Time</label>
                                <input type="time" id="etaTime1" required>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="notes1">Notes for Line Manager <span class="optional-label">(Optional)</span></label>
                        <textarea id="notes1" rows="4" placeholder="Additional travel details..."></textarea>
                    </div>

                    <button type="submit" class="submit-btn">Submit Travel Details</button>
                </form>
            </div>

            <!-- Manage Trip Form -->
            <div id="manage" class="form-container">
                <div class="form-header">
                    <h2>üîß Manage Trip</h2>
                    <p>Update your ETA, mark arrival, or cancel your trip</p>
                </div>

                <!-- I Have Arrived Section -->
                <div class="manage-section">
                    <h3>üéØ Mark Arrival</h3>
                    <p>Click this when you've safely arrived at your destination.</p>
                    <div class="success-message" id="successMessageArrived">Arrival confirmed! ‚úÖ Your status has been updated.</div>
                    <div class="error-message" id="errorMessageArrived">Error updating arrival status. Please try again.</div>
                    <div class="form-group hidden">
                        <input type="email" id="userEmailArrived">
                    </div>
                    <button type="button" class="arrived-btn" id="arrivedBtn">‚úÖ I Have Arrived</button>
                </div>

                <!-- Update ETA Section -->
                <div class="manage-section">
                    <h3>üîÑ Update ETA</h3>
                    <p>Use this if your arrival time has changed from your original submission.</p>
                    <div class="success-message" id="successMessage2">ETA updated successfully! ‚úÖ</div>
                    <div class="error-message" id="errorMessage2">Error updating ETA. Please try again.</div>
                    <form id="etaUpdateForm">
                        <div class="form-group hidden">
                            <input type="email" id="userEmail2" required>
                        </div>
                        <div class="form-group">
                            <label>New ETA Date & Time<span class="required-asterisk">*</span></label>
                            <div class="datetime-group">
                                <div class="datetime-field">
                                    <label for="etaDate2">Date</label>
                                    <input type="date" id="etaDate2" required>
                                </div>
                                <div class="datetime-field">
                                    <label for="etaTime2">Time</label>
                                    <input type="time" id="etaTime2" required>
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="submit-btn">Update ETA</button>
                    </form>
                </div>

                <!-- Cancel Trip Section -->
                <div class="manage-section">
                    <h3>‚ùå Cancel Trip</h3>
                    <p><strong>Warning:</strong> This will cancel your entire trip registration. This action cannot be undone.</p>
                    <div class="success-message" id="successMessage3"><strong>Trip cancelled successfully!</strong> Your travel registration has been removed.</div>
                    <div class="error-message" id="errorMessage3"><strong>Error:</strong> Unable to cancel trip. Please try again or contact support.</div>
                    <form id="cancelTripForm">
                        <div class="form-group hidden">
                            <input type="email" id="userEmail3" required>
                        </div>
                        <div class="action-buttons">
                            <button type="button" class="cancel-btn" id="cancelBtn">‚ùå Cancel Trip</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        let map, marker, autocomplete, directionsService, directionsRenderer, userLocation = null;

        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: -36.8485, lng: 174.7633 },
                zoom: 10,
                styles: [{ featureType: 'poi', elementType: 'labels', stylers: [{ visibility: 'off' }] }]
            });
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({ draggable: false, suppressMarkers: false });
            directionsRenderer.setMap(map);

            const destinationInput = document.getElementById('destination');
            autocomplete = new google.maps.places.Autocomplete(destinationInput, {
                componentRestrictions: { country: 'nz' },
                fields: ['place_id', 'geometry', 'name', 'formatted_address'],
                types: ['establishment', 'geocode']
            });

            // Flight destination - autocomplete only, no map
            new google.maps.places.Autocomplete(document.getElementById('flightDestination'), {
                componentRestrictions: { country: 'nz' },
                fields: ['formatted_address', 'name'],
                types: ['establishment', 'geocode']
            });

            autocomplete.addListener('place_changed', function() {
                const place = autocomplete.getPlace();
                if (!place.geometry) return;
                showMapContainer();
                if (place.geometry.viewport) {
                    map.fitBounds(place.geometry.viewport);
                } else {
                    map.setCenter(place.geometry.location);
                    map.setZoom(15);
                }
                if (marker) marker.setMap(null);
                marker = new google.maps.Marker({ position: place.geometry.location, map: map, title: place.name });
                if (userLocation) {
                    calculateTravelTime(userLocation, place.geometry.location);
                } else {
                    getCurrentLocation();
                }
            });
        }

        function getCurrentLocation() {
            if (navigator.geolocation) {
                const travelInfo = document.getElementById('travelInfo');
                const travelTime = document.getElementById('travelTime');
                travelInfo.classList.add('show');
                travelTime.innerHTML = '<span class="loading-spinner"></span> Getting your location...';
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        userLocation = { lat: position.coords.latitude, lng: position.coords.longitude };
                        const place = autocomplete.getPlace();
                        if (place && place.geometry) {
                            calculateTravelTime(userLocation, place.geometry.location);
                        } else {
                            travelInfo.classList.remove('show');
                        }
                    },
                    function(error) {
                        document.getElementById('travelTime').innerHTML = '‚ùå Unable to get your location';
                        setTimeout(() => travelInfo.classList.remove('show'), 3000);
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 300000 }
                );
            } else {
                alert('Geolocation is not supported by this browser.');
            }
        }

        function calculateTravelTime(origin, destination) {
            const travelInfo = document.getElementById('travelInfo');
            const travelTime = document.getElementById('travelTime');
            const travelDistance = document.getElementById('travelDistance');
            travelInfo.classList.add('show');
            travelTime.innerHTML = '<span class="loading-spinner"></span> Calculating travel time...';
            travelDistance.textContent = '';
            directionsService.route({
                origin: origin,
                destination: destination,
                travelMode: google.maps.TravelMode.DRIVING,
                unitSystem: google.maps.UnitSystem.METRIC
            }, function(result, status) {
                if (status === 'OK') {
                    directionsRenderer.setDirections(result);
                    const leg = result.routes[0].legs[0];
                    travelTime.textContent = leg.duration.text;
                    travelDistance.textContent = leg.distance.text + ' via ' + (result.routes[0].summary || 'best route');
                } else {
                    travelTime.textContent = '‚ùå Unable to calculate travel time';
                    travelDistance.textContent = 'Please check your destination address';
                }
            });
        }

        function showMapContainer() {
            document.getElementById('mapContainer').classList.add('show');
        }

        document.addEventListener('DOMContentLoaded', function() {
            if (typeof microsoftTeams !== 'undefined') {
                try {
                    microsoftTeams.app.initialize().then(() => {
                        microsoftTeams.app.getContext().then((context) => {
                            const userEmail = context.user?.userPrincipalName || context.user?.mail;
                            if (userEmail) {
                                document.getElementById('userEmail1').value = userEmail;
                                document.getElementById('userEmail2').value = userEmail;
                                document.getElementById('userEmail3').value = userEmail;
                                document.getElementById('userEmailArrived').value = userEmail;
                            }
                            applyTeamsTheme(context.app?.theme);
                        }).catch(() => applyTeamsTheme('default'));
                    }).catch(() => applyTeamsTheme('default'));
                } catch (error) {
                    applyTeamsTheme('default');
                }
            } else {
                applyTeamsTheme('default');
            }

            const nzDate = new Date().toLocaleDateString('en-CA', { timeZone: 'Pacific/Auckland' });
            document.getElementById('etaDate1').value = nzDate;
            document.getElementById('etaDate2').value = nzDate;
            document.getElementById('etaDate1').min = nzDate;
            document.getElementById('etaDate2').min = nzDate;
        });

        function applyTeamsTheme(theme) {
            document.body.classList.remove('teams-dark-theme', 'teams-contrast-theme');
            if (theme === 'dark') document.body.classList.add('teams-dark-theme');
            else if (theme === 'contrast') document.body.classList.add('teams-contrast-theme');
        }

        // Transport change handler - controls which fields appear
        document.getElementById('transport').addEventListener('change', function() {
            const flightGroup = document.getElementById('flightGroup');
            const flightAddressGroup = document.getElementById('flightAddressGroup');
            const carTravelSection = document.getElementById('carTravelSection');

            if (this.value === 'Flight') {
                // Show flight number + flight destination address (plain text)
                flightGroup.classList.add('show');
                flightAddressGroup.classList.add('show');
                // Hide car section
                carTravelSection.classList.remove('show');
                document.getElementById('mapContainer').classList.remove('show');
                document.getElementById('travelInfo').classList.remove('show');
                document.getElementById('destination').value = '';
            } else if (this.value === 'Car') {
                // Show car destination (with maps)
                carTravelSection.classList.add('show');
                // Hide flight fields
                flightGroup.classList.remove('show');
                flightAddressGroup.classList.remove('show');
                document.getElementById('flightNumber').value = '';
                document.getElementById('flightDestination').value = '';
            } else {
                // Nothing selected - hide all conditional fields
                flightGroup.classList.remove('show');
                flightAddressGroup.classList.remove('show');
                carTravelSection.classList.remove('show');
                document.getElementById('flightNumber').value = '';
                document.getElementById('flightDestination').value = '';
                document.getElementById('destination').value = '';
                document.getElementById('mapContainer').classList.remove('show');
                document.getElementById('travelInfo').classList.remove('show');
            }
        });

        function showTab(tabName, e) {
            document.querySelectorAll('.form-container').forEach(f => f.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            if (e && e.currentTarget) e.currentTarget.classList.add('active');
        }

        // Travel form submission
        document.getElementById('travelForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const submitBtn = this.querySelector('.submit-btn');
            const successMsg = document.getElementById('successMessage1');
            const errorMsg = document.getElementById('errorMessage1');
            const originalText = submitBtn.textContent;
            successMsg.style.display = 'none';
            errorMsg.style.display = 'none';
            submitBtn.style.background = '#6c757d';
            submitBtn.textContent = 'Submitting...';
            submitBtn.disabled = true;

            const userEmail = document.getElementById('userEmail1').value;
            const transport = document.getElementById('transport').value;
            const formData = {
                userName: userEmail.split('@')[0],
                userEmail: userEmail,
                transport: transport,
                etaDate: document.getElementById('etaDate1').value,
                etaTime: document.getElementById('etaTime1').value,
                notes: document.getElementById('notes1').value,
                timestamp: new Date().toISOString()
            };

            if (transport === 'Flight') {
                formData.flightNumber = document.getElementById('flightNumber').value;
                const flightDest = document.getElementById('flightDestination').value;
                if (flightDest) formData.destination = flightDest;
            } else if (transport === 'Car') {
                const carDest = document.getElementById('destination').value;
                if (carDest) {
                    formData.destination = carDest;
                    const travelTimeEl = document.getElementById('travelTime');
                    if (travelTimeEl && !travelTimeEl.textContent.includes('Calculating')) {
                        formData.travelTime = travelTimeEl.textContent;
                        formData.travelDistance = document.getElementById('travelDistance').textContent;
                    }
                }
            }

            try {
                const response = await fetch('https://default3ffbd39b3029417e891279948e9101.5d.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/0a80b39b54e44246a9ce509298135c7b/triggers/manual/paths/invoke/?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=_opbad6juUMvJhdiqPcJF7rIAgY9qZ-LklhQJF0UWrg', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                if (response.ok) {
                    submitBtn.style.background = '#107c10';
                    submitBtn.textContent = '‚úÖ Submitted Successfully!';
                    successMsg.style.display = 'block';
                    setTimeout(() => {
                        this.reset();
                        document.getElementById('flightGroup').classList.remove('show');
                        document.getElementById('flightAddressGroup').classList.remove('show');
                        document.getElementById('carTravelSection').classList.remove('show');
                        document.getElementById('mapContainer').classList.remove('show');
                        document.getElementById('travelInfo').classList.remove('show');
                        submitBtn.style.background = '#6264a7';
                        submitBtn.textContent = originalText;
                        submitBtn.disabled = false;
                        successMsg.style.display = 'none';
                        const nzDate = new Date().toLocaleDateString('en-CA', { timeZone: 'Pacific/Auckland' });
                        document.getElementById('etaDate1').value = nzDate;
                    }, 2000);
                } else { throw new Error('Submission failed'); }
            } catch (error) {
                submitBtn.style.background = '#d13438';
                submitBtn.textContent = '‚ùå Submission Failed';
                errorMsg.style.display = 'block';
                setTimeout(() => {
                    submitBtn.style.background = '#6264a7';
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                    errorMsg.style.display = 'none';
                }, 3000);
            }
        });

        // ETA update form
        document.getElementById('etaUpdateForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const submitBtn = this.querySelector('.submit-btn');
            const successMsg = document.getElementById('successMessage2');
            const errorMsg = document.getElementById('errorMessage2');
            const originalText = submitBtn.textContent;
            successMsg.style.display = 'none';
            errorMsg.style.display = 'none';
            submitBtn.style.background = '#6c757d';
            submitBtn.textContent = 'Updating...';
            submitBtn.disabled = true;
            const userEmail = document.getElementById('userEmail2').value;
            const formData = {
                userName: userEmail.split('@')[0],
                userEmail: userEmail,
                etaDate: document.getElementById('etaDate2').value,
                etaTime: document.getElementById('etaTime2').value,
                timestamp: new Date().toISOString()
            };
            try {
                const response = await fetch('https://default3ffbd39b3029417e891279948e9101.5d.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/4410b6d4f4e24c31b4c807753e8bf4b0/triggers/manual/paths/invoke/?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=lXbmTgs40Fi9ugoYRDeFvlYg4hr-vTmelNL-C0wR-yI', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                if (response.ok) {
                    submitBtn.style.background = '#107c10';
                    submitBtn.textContent = '‚úÖ ETA Updated Successfully!';
                    successMsg.style.display = 'block';
                    setTimeout(() => {
                        this.reset();
                        submitBtn.style.background = '#6264a7';
                        submitBtn.textContent = originalText;
                        submitBtn.disabled = false;
                        successMsg.style.display = 'none';
                        const nzDate = new Date().toLocaleDateString('en-CA', { timeZone: 'Pacific/Auckland' });
                        document.getElementById('etaDate2').value = nzDate;
                    }, 2000);
                } else { throw new Error('Update failed'); }
            } catch (error) {
                submitBtn.style.background = '#d13438';
                submitBtn.textContent = '‚ùå Update Failed';
                errorMsg.style.display = 'block';
                setTimeout(() => {
                    submitBtn.style.background = '#6264a7';
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                    errorMsg.style.display = 'none';
                }, 3000);
            }
        });

        // Arrived button
        document.getElementById('arrivedBtn').addEventListener('click', async function() {
            const successMsg = document.getElementById('successMessageArrived');
            const errorMsg = document.getElementById('errorMessageArrived');
            const originalText = this.textContent;
            successMsg.style.display = 'none';
            errorMsg.style.display = 'none';
            this.style.background = '#6c757d';
            this.textContent = '‚è≥ Updating Status...';
            this.disabled = true;
            const userEmail = document.getElementById('userEmailArrived').value;
            const formData = {
                userName: userEmail.split('@')[0],
                userEmail: userEmail,
                status: 'arrived',
                arrivalTime: new Date().toISOString(),
                timestamp: new Date().toISOString()
            };
            try {
                const response = await fetch('https://default3ffbd39b3029417e891279948e9101.5d.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/062bbf055e82405daa679785cf6438d6/triggers/manual/paths/invoke/?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=pBCTUNLSTG9SBBSFjugGs2kN1OZmVpXExtbrjPkzkjM', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                if (response.ok) {
                    this.style.background = '#107c10';
                    this.textContent = '‚úÖ Arrival Confirmed!';
                    successMsg.style.display = 'block';
                    setTimeout(() => {
                        this.style.background = '#107c10';
                        this.textContent = '‚úÖ Already Arrived';
                        this.disabled = true;
                        successMsg.style.display = 'none';
                    }, 5000);
                } else { throw new Error('Arrival update failed'); }
            } catch (error) {
                errorMsg.style.display = 'block';
                this.style.background = '#107c10';
                this.textContent = originalText;
                this.disabled = false;
            }
        });

        // Cancel trip button
        document.getElementById('cancelBtn').addEventListener('click', async function() {
            const successMsg = document.getElementById('successMessage3');
            const errorMsg = document.getElementById('errorMessage3');
            const originalText = this.textContent;
            successMsg.style.display = 'none';
            errorMsg.style.display = 'none';
            this.style.background = '#6c757d';
            this.textContent = '‚è≥ Cancelling...';
            this.disabled = true;
            const userEmail = document.getElementById('userEmail3').value;
            const formData = {
                userName: userEmail.split('@')[0],
                userEmail: userEmail,
                timestamp: new Date().toISOString()
            };
            try {
                const response = await fetch('https://default3ffbd39b3029417e891279948e9101.5d.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/ab4f6fca46f1414d87158be9aa0375e6/triggers/manual/paths/invoke/?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=m8x0wKtn08bg-4xVyGToINp2MuwVpczO2vgCJYWyc0g', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                if (response.ok) {
                    successMsg.style.display = 'block';
                    this.style.background = '#d13438';
                    this.textContent = originalText;
                    this.disabled = false;
                    document.getElementById('cancelTripForm').reset();
                } else { throw new Error('Cancellation failed'); }
            } catch (error) {
                errorMsg.style.display = 'block';
                this.style.background = '#d13438';
                this.textContent = originalText;
                this.disabled = false;
            }
        });
    </script>
</body>
</html>
